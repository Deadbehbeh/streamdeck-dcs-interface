<!DOCTYPE HTML>
<html>

<head>
	<title>com.ctytler.dcs.idLookupWindow</title>
	<meta charset="utf-8" />
	<link rel="stylesheet" href="css/sdpi.css">
	<style>
		body {
			background-color: transparent;
		}

		.sdpi-item {
			max-width: none !important;
		}

		.sdpi-heading {
			margin: 16px 0;
		}

		ul {
			max-height: none;
		}

		li * {
			min-height: 18px;
			padding: 4px;
			display: flex;
			align-items: center;
		}

		.wrap {
			margin: 0 auto;
			max-width: 600px;
		}

		.title {
			font-weight: bold;
			padding-bottom: 2px;
			margin-bottom: 6px;
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
			text-transform: uppercase;
		}

		.wrap {
			text-align: center;
		}
	</style>
</head>

<body onload="loaded()">

	<div class="sdpi-wrapper">
		<div id="connection_settings_div">
			<div class="sdpi-heading">DCS World Installation Directory</div>
			<div class="wrap">
				<p>Please identify your DCS World installation directory so button IDs can be queried. </p>

			</div>

			<div class="wrap" style="max-width: 600px;">

				<div class="sdpi-item">
					<div class="sdpi-item-label">DCS World Install Directory</div>
					<input id="dcs_install_path" class="sdpi-item-value" type="text"
						value="C:\Program Files\Eagle Dynamics\DCS World OpenBeta"
						placeholder="Default: C:\Program Files\Eagle Dynamics\DCS World" />

					<button id="dcs_install_path_save_button" type="button" value="Save"
						onclick="callbackSaveDcsInstallPath()">Save</button>
				</div>
			</div>
		</div>

		<div class="sdpi-heading">DCS Module Clickable Data</div>
		<div class="wrap" style="max-width: 300px;">
			<div class="sdpi-item" id="modules">
				<div class="sdpi-item-label">Select Module</div>
				<select class="sdpi-item-value select" id="select_module" onchange="callbackRequestIdLookup()">
				</select>
			</div>
		</div>
		<div class="wrap" style="max-width: 400px;">
			<br></br>
			<div class="sdpi-item">
				<input id="clickabledata_table_search" class="sdpi-item-value" type="text" value=""
					placeholder="Search.." onchange="searchTable()" />
			</div>
		</div>

		<div class="wrap" style="min-width: 900px;">
			<div class="sdpi-item" id="clickabledata_table">
				<table class="sdpi-item-value no-select" width="70%">
					<thead>
						<tr>
							<td><b>Device (ID)</b></td>
							<td><b>Button ID</b></td>
							<td><b>Element</b></td>
							<td><b>Type</b></td>
							<td><b>DCS ID</b></td>
							<td><b>Click Value</b></td>
							<td><b>Limit Min</b></td>
							<td><b>Limit Max</b></td>
							<td><b>Description</b></td>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</div>

	</div>

	<script>
		function callbackSaveDcsInstallPath() {
			var dcs_install_path = document.getElementById("dcs_install_path").value;
			sendmessage("RequestInstalledModules", dcs_install_path);
		}

		function gotInstalledModules(installed_modules_list) {
			var select_elem = document.getElementById("select_module");
			for (module of installed_modules_list) {
				var option = document.createElement('option');
				option.appendChild(document.createTextNode(module));
				option.value = module;
				select_elem.append(option);
			}
		}

		function callbackRequestIdLookup() {
			var select_elem = document.getElementById("select_module");
			var module = select_elem.options[select_elem.selectedIndex].value;
			var dcs_install_path = document.getElementById("dcs_install_path").value;
			var payload = { "dcs_install_path": dcs_install_path, "module": module };
			sendmessage("RequestIdLookup", payload);
			console.log("Request ID Lookup for: ", payload);
			document.getElementById("clickabledata_table_search").value = "";
		}

		function gotClickabledata(clickabledata_elements) {
			// Create rows in a new table body so it is easy to replace any old content.
			var new_table_body = document.createElement('tbody');
			clickabledata_elements.sort();
			for (const element of clickabledata_elements) {
				var split_elem = element.split(',');
				var new_row = new_table_body.insertRow();
				new_row.insertCell(0).appendChild(document.createTextNode(split_elem[0])); // Device
				new_row.insertCell(1).appendChild(document.createTextNode(split_elem[1])); // Button ID
				new_row.insertCell(2).appendChild(document.createTextNode(split_elem[2])); // Element
				new_row.insertCell(3).appendChild(document.createTextNode(split_elem[3])); // Type
				new_row.insertCell(4).appendChild(document.createTextNode(split_elem[4])); // DCS ID
				new_row.insertCell(5).appendChild(document.createTextNode(split_elem[5])); // Click Value
				new_row.insertCell(6).appendChild(document.createTextNode(split_elem[6])); // Limit Min
				new_row.insertCell(7).appendChild(document.createTextNode(split_elem[7])); // Limit Max
				new_row.insertCell(8).appendChild(document.createTextNode(split_elem[8])); // Description
			}
			var document_table_body = document.getElementById("clickabledata_table").getElementsByTagName('tbody')[0];
			document_table_body.parentNode.replaceChild(new_table_body, document_table_body);
			console.log("Loaded elements: ", clickabledata_elements);
		}


		function searchTable() {
			console.log("Sorting");
			var query = document.getElementById("clickabledata_table_search").value.toUpperCase();
			var table = document.getElementById("clickabledata_table");
			var tr = table.getElementsByTagName("td")[0];
			for (var i = 0; i < tr.length; i++) {
				var td = tr[i].getElementsByTagName("td")[0];
				if (td) {
					var row_text = td.textContent || td.innerText;
					console.log("Row text: ", row_text);
					if (row_text.toUpperCase().indexOf(query) >= 0) {
						tr[i].style.display = "";
					}
					else {
						tr[i].style.display = "none";
					}
				}
			}
		}


		/** Functions for communication with original window **/

		function loaded() {
			setTimeout(() => {
				// this is just a quick message to Property Inspector (you should see it in the console)
				window.opener.gotCallbackFromWindow("Message from window: " + new Date().toLocaleTimeString());
			}, 1000);

		};

		function sendmessage(event, payload) {
			// Calls function from original (Property Inspector) window.
			var msg = { "event": event }
			if (payload) {
				msg["payload"] = payload;
			}
			window.opener.gotCallbackFromIdLookupWindow(msg);
		}

	</script>

</body>

</html>